# =============================================================================
# Security Scanning Pipeline
# =============================================================================
name: Security Scan

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}

jobs:
  # ---------------------------------------------------------------------------
  # Snyk Open Source (SCA)
  # ---------------------------------------------------------------------------
  snyk-sca:
    name: Snyk SCA Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Snyk SCA
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --json-file-output=snyk-sca-report.json

      - name: Upload SCA report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-report
          path: snyk-sca-report.json

  # ---------------------------------------------------------------------------
  # Snyk Code (SAST)
  # ---------------------------------------------------------------------------
  snyk-code:
    name: Snyk Code Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk Code
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --json-file-output=snyk-code-report.json

      - name: Upload Code report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-code-report
          path: snyk-code-report.json

  # ---------------------------------------------------------------------------
  # Snyk IaC
  # ---------------------------------------------------------------------------
  snyk-iac:
    name: Snyk IaC Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk IaC scan
        uses: snyk/actions/iac@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --json-file-output=snyk-iac-report.json
        continue-on-error: true

      - name: Upload IaC report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-iac-report
          path: snyk-iac-report.json

  # ---------------------------------------------------------------------------
  # Container Scan
  # ---------------------------------------------------------------------------
  snyk-container:
    name: Snyk Container Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t aibom-app:scan .

      - name: Run Snyk Container scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: aibom-app:scan
          args: --json-file-output=snyk-container-report.json
        continue-on-error: true

      - name: Upload Container report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-container-report
          path: snyk-container-report.json

  # ---------------------------------------------------------------------------
  # Generate AIBOM
  # ---------------------------------------------------------------------------
  aibom:
    name: Generate AIBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master

      - name: Generate AIBOM
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk auth $SNYK_TOKEN
          snyk aibom --json > aibom-report.json || true

      - name: Upload AIBOM
        uses: actions/upload-artifact@v4
        with:
          name: aibom-report
          path: aibom-report.json

  # ---------------------------------------------------------------------------
  # Aggregate Reports
  # ---------------------------------------------------------------------------
  aggregate-reports:
    name: Aggregate Security Reports
    runs-on: ubuntu-latest
    needs: [snyk-sca, snyk-code, snyk-iac, snyk-container, aibom]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Create summary report
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "Generated: $(date -u)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Reports Generated" >> security-summary.md
          ls -la security-reports/ >> security-summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

